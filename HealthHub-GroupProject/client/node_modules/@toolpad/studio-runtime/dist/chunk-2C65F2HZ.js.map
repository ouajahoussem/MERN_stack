{"version":3,"sources":["../src/auth.ts"],"sourcesContent":["import type express from 'express';\nimport { getToken } from '@auth/core/jwt';\nimport { adaptRequestFromExpressToFetch } from '@toolpad/utils/httpApiAdapters';\nimport { FirestoreAdapter } from '@auth/firebase-adapter';\nimport * as cookie from 'cookie';\n\ninterface SessionUser {\n  name?: string | null;\n  email?: string | null;\n  avatar?: string | null;\n  roles?: string[];\n}\n\nexport type Session = { user: SessionUser } | null;\n\nexport async function getSession(req: express.Request): Promise<Session | null> {\n  const request = adaptRequestFromExpressToFetch(req);\n\n  const session = null;\n  if (process.env.TOOLPAD_AUTH_SECRET) {\n    const firebaseAdapter = FirestoreAdapter();\n\n    if (process.env.GOOGLE_APPLICATION_CREDENTIALS && firebaseAdapter.getSessionAndUser) {\n      const parsedCookies = cookie.parse(req.headers.cookie ?? '');\n\n      const sessionToken = parsedCookies['authjs.session-token'];\n\n      const firebaseSessionAndUser = sessionToken\n        ? await firebaseAdapter.getSessionAndUser(sessionToken)\n        : null;\n\n      return (\n        firebaseSessionAndUser && {\n          user: {\n            name: firebaseSessionAndUser.user.name,\n            email: firebaseSessionAndUser.user.email,\n            avatar: firebaseSessionAndUser.user.image,\n            roles: [],\n          },\n        }\n      );\n    }\n\n    // @TODO: Library types are wrong as salt should not be required, remove once fixed\n    // Github discussion: https://github.com/nextauthjs/next-auth/discussions/9133\n    // @ts-ignore\n    const token = await getToken({\n      req: request,\n      secret: process.env.TOOLPAD_AUTH_SECRET,\n    });\n\n    return (\n      token && {\n        user: {\n          name: token.name,\n          email: token.email,\n          avatar: token.picture,\n          roles: token.roles,\n        },\n      }\n    );\n  }\n\n  return session;\n}\n"],"mappings":";AACA,SAAS,gBAAgB;AACzB,SAAS,sCAAsC;AAC/C,SAAS,wBAAwB;AACjC,YAAY,YAAY;AAWxB,eAAsB,WAAW,KAA+C;AAC9E,QAAM,UAAU,+BAA+B,GAAG;AAElD,QAAM,UAAU;AAChB,MAAI,QAAQ,IAAI,qBAAqB;AACnC,UAAM,kBAAkB,iBAAiB;AAEzC,QAAI,QAAQ,IAAI,kCAAkC,gBAAgB,mBAAmB;AACnF,YAAM,gBAAuB,aAAM,IAAI,QAAQ,UAAU,EAAE;AAE3D,YAAM,eAAe,cAAc,sBAAsB;AAEzD,YAAM,yBAAyB,eAC3B,MAAM,gBAAgB,kBAAkB,YAAY,IACpD;AAEJ,aACE,0BAA0B;AAAA,QACxB,MAAM;AAAA,UACJ,MAAM,uBAAuB,KAAK;AAAA,UAClC,OAAO,uBAAuB,KAAK;AAAA,UACnC,QAAQ,uBAAuB,KAAK;AAAA,UACpC,OAAO,CAAC;AAAA,QACV;AAAA,MACF;AAAA,IAEJ;AAKA,UAAM,QAAQ,MAAM,SAAS;AAAA,MAC3B,KAAK;AAAA,MACL,QAAQ,QAAQ,IAAI;AAAA,IACtB,CAAC;AAED,WACE,SAAS;AAAA,MACP,MAAM;AAAA,QACJ,MAAM,MAAM;AAAA,QACZ,OAAO,MAAM;AAAA,QACb,QAAQ,MAAM;AAAA,QACd,OAAO,MAAM;AAAA,MACf;AAAA,IACF;AAAA,EAEJ;AAEA,SAAO;AACT;","names":[]}